{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <h2>Pin Location for {{ client.full_name }}</h2>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div id="map" style="height: 500px; width: 100%; border: 1px solid #ccc;"></div>
                    <div class="mt-3">
                        <button id="getLocation" class="btn btn-primary">
                            üìç Use My Current Location
                        </button>
                        <button id="saveLocation" class="btn btn-success" disabled>
                            üíæ Save This Location
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>Location Details</h5>
                    <p><strong>Latitude:</strong> <span id="latDisplay">Not set</span></p>
                    <p><strong>Longitude:</strong> <span id="lngDisplay">Not set</span></p>
                    <p><strong>Address:</strong> <span id="addressDisplay">Not set</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places"></script>

<script>
let map;
let marker;
let currentLat = null;
let currentLng = null;

// Initialize map
function initMap() {
    // Default center (Nairobi)
    const defaultCenter = { lat: -1.2921, lng: 36.8219 };
    
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: defaultCenter,
    });
    
    // Add click listener to map
    map.addListener("click", (event) => {
        setMarker(event.latLng);
    });
}

// Set marker on map
function setMarker(latLng) {
    if (marker) {
        marker.setMap(null);
    }
    
    marker = new google.maps.Marker({
        position: latLng,
        map: map,
        draggable: true,
        title: "Client Location"
    });
    
    currentLat = latLng.lat();
    currentLng = latLng.lng();
    
    // Update display
    document.getElementById('latDisplay').textContent = currentLat.toFixed(6);
    document.getElementById('lngDisplay').textContent = currentLng.toFixed(6);
    document.getElementById('saveLocation').disabled = false;
    
    // Get address from coordinates
    getAddressFromCoords(currentLat, currentLng);
    
    // Center map on marker
    map.panTo(latLng);
}

// Get current location
document.getElementById('getLocation').addEventListener('click', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const latLng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                setMarker(latLng);
            },
            function(error) {
                alert('Error getting location: ' + error.message);
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
});

// Save location
document.getElementById('saveLocation').addEventListener('click', function() {
    if (currentLat && currentLng) {
        fetch("{% url 'save_client_location' client.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                latitude: currentLat,
                longitude: currentLng
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Location saved successfully!');
                window.location.href = "{% url 'client_list' %}";
            } else {
                alert('Error saving location: ' + data.message);
            }
        });
    }
});

// Get address from coordinates
function getAddressFromCoords(lat, lng) {
    const geocoder = new google.maps.Geocoder();
    const latLng = { lat: lat, lng: lng };
    
    geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === "OK" && results[0]) {
            document.getElementById('addressDisplay').textContent = results[0].formatted_address;
        } else {
            document.getElementById('addressDisplay').textContent = "Address not found";
        }
    });
}

// Initialize map when page loads
initMap();
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üìç Pin Location for {{ client.full_name }}</h2>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <!-- Map Container -->
                    <div id="map" style="height: 500px; width: 100%; border: 1px solid #ccc;"></div>
                    
                    <div class="mt-3">
                        <button id="getLocation" class="btn btn-primary">
                            üìç Use My Current Location
                        </button>
                        <button id="pickLocation" class="btn btn-info">
                            üó∫Ô∏è Click on Map to Pick Location
                        </button>
                        <button id="saveLocation" class="btn btn-success" disabled>
                            üíæ Save This Location
                        </button>
                        <a href="{% url 'client_list' %}" class="btn btn-secondary">‚Üê Back to Clients</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>üìç Location Details</h5>
                    <p><strong>Latitude:</strong> <span id="latDisplay">Not set</span></p>
                    <p><strong>Longitude:</strong> <span id="lngDisplay">Not set</span></p>
                    <p><strong>Address:</strong> <span id="addressDisplay">Not set</span></p>
                    
                    <div class="mt-3">
                        <h6>Instructions:</h6>
                        <small class="text-muted">
                            1. Click "Use My Current Location" to auto-detect<br>
                            2. OR click on the map to pick location<br>
                            3. Click "Save This Location" when done
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let marker;
let currentLat = null;
let currentLng = null;

// Initialize map
function initMap() {
    // Default center (Nairobi)
    const defaultCenter = [-1.2921, 36.8219];
    
    // Create map
    map = L.map('map').setView(defaultCenter, 12);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add click listener to map
    map.on('click', function(e) {
        setMarker(e.latlng);
    });
    
    // Instructions
    document.getElementById('pickLocation').addEventListener('click', function() {
        alert('Click anywhere on the map to set the location marker.');
    });
}

// Set marker on map
function setMarker(latlng) {
    // Remove existing marker
    if (marker) {
        map.removeLayer(marker);
    }
    
    // Add new marker
    marker = L.marker(latlng).addTo(map)
        .bindPopup('Client Location<br>Drag to adjust')
        .openPopup();
    
    // Make marker draggable
    marker.dragging.enable();
    
    // Update coordinates when marker is dragged
    marker.on('dragend', function(e) {
        const position = marker.getLatLng();
        updateCoordinates(position.lat, position.lng);
    });
    
    // Update coordinates
    updateCoordinates(latlng.lat, latlng.lng);
    
    // Center map on marker
    map.panTo(latlng);
}

// Update coordinate displays
function updateCoordinates(lat, lng) {
    currentLat = lat;
    currentLng = lng;
    
    // Update display
    document.getElementById('latDisplay').textContent = lat.toFixed(6);
    document.getElementById('lngDisplay').textContent = lng.toFixed(6);
    document.getElementById('saveLocation').disabled = false;
    
    // Try to get address (simplified)
    getSimpleAddress(lat, lng);
}

// Get current location using browser geolocation
document.getElementById('getLocation').addEventListener('click', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                setMarker({ lat: lat, lng: lng });
            },
            function(error) {
                let errorMessage = 'Error getting location: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'User denied location access.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'Unknown error occurred.';
                        break;
                }
                alert(errorMessage);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
});

// Save location to server
document.getElementById('saveLocation').addEventListener('click', function() {
    if (currentLat && currentLng) {
        // Show loading state
        const saveBtn = document.getElementById('saveLocation');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '‚è≥ Saving...';
        
        fetch("{% url 'save_client_location' client.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                latitude: currentLat,
                longitude: currentLng,
                address: document.getElementById('addressDisplay').textContent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('‚úÖ Location saved successfully!');
                window.location.href = "{% url 'client_list' %}";
            } else {
                alert('‚ùå Error saving location: ' + data.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'üíæ Save This Location';
            }
        })
        .catch(error => {
            alert('‚ùå Network error: ' + error);
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'üíæ Save This Location';
        });
    }
});

// Simple address lookup (you can enhance this later)
function getSimpleAddress(lat, lng) {
    // For now, we'll just show coordinates
    // You can add OpenStreetMap Nominatim API later if needed
    document.getElementById('addressDisplay').textContent = `Near ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
<a href="{% url 'client_location_pin' client.id %}" class="btn btn-sm btn-outline-primary">
    üìç Pin Location
</a>